using System;
using System.Drawing;
using System.Windows.Forms;
using System.Threading.Tasks;
using Moq;
using Xunit;

namespace DigitalWindexTest
{
    // ✅ Mockable interface for malware scanning
    public interface IMalwareScanner
    {
        Task ScanAsync();
    }

    // ✅ Testable version of the MalwareControl
    public class MalwareControlTestable : UserControl
    {
        private readonly IMalwareScanner _scanner;

        public Label lblTitle;
        public Label lblDescription;
        public Button btnScanMalware;

        public MalwareControlTestable(IMalwareScanner scanner)
        {
            _scanner = scanner;
            InitializeComponent();
        }

        private void InitializeComponent()
        {
            this.lblTitle = new Label();
            this.lblDescription = new Label();
            this.btnScanMalware = new Button();

            // lblTitle
            this.lblTitle.Font = new Font("Century Gothic", 28F, FontStyle.Bold);
            this.lblTitle.ForeColor = Color.FromArgb(103, 80, 164);
            this.lblTitle.Location = new Point(0, 40);
            this.lblTitle.Name = "lblTitle";
            this.lblTitle.Size = new Size(1005, 60);
            this.lblTitle.Text = "Malware Scan";
            this.lblTitle.TextAlign = ContentAlignment.MiddleCenter;

            // lblDescription
            this.lblDescription.Font = new Font("Segoe UI", 11F, FontStyle.Italic);
            this.lblDescription.ForeColor = Color.DimGray;
            this.lblDescription.Location = new Point(150, 120);
            this.lblDescription.Name = "lblDescription";
            this.lblDescription.Size = new Size(705, 60);
            this.lblDescription.Text = "Run a malware scan to detect potential threats on your system.";
            this.lblDescription.TextAlign = ContentAlignment.TopCenter;
            this.lblDescription.MaximumSize = new Size(800, 0);
            this.lblDescription.AutoSize = true;

            // btnScanMalware
            this.btnScanMalware.Font = new Font("Segoe UI", 10F, FontStyle.Bold);
            this.btnScanMalware.Location = new Point(392, 210);
            this.btnScanMalware.Name = "btnScanMalware";
            this.btnScanMalware.Size = new Size(220, 45);
            this.btnScanMalware.Text = "Scan for Malware";
            this.btnScanMalware.UseVisualStyleBackColor = true;
            this.btnScanMalware.Click += BtnScanMalware_Click;

            // MalwareControlTestable
            this.BackColor = Color.FromArgb(244, 246, 249);
            this.Controls.Add(this.lblTitle);
            this.Controls.Add(this.lblDescription);
            this.Controls.Add(this.btnScanMalware);
            this.Name = "MalwareControlTestable";
            this.Size = new Size(1005, 600);
        }

        private async void BtnScanMalware_Click(object sender, EventArgs e)
        {
            await _scanner.ScanAsync();
        }
    }

    // ✅ Unit test using Moq
    public class MalwareControlTests
    {
        [Fact]
        public void BtnScanMalware_Click_CallsScanAsync()
        {
            // Arrange
            var mockScanner = new Mock<IMalwareScanner>();
            mockScanner.Setup(s => s.ScanAsync()).Returns(Task.CompletedTask);

            var control = new MalwareControlTestable(mockScanner.Object);

            // Act
            control.btnScanMalware.PerformClick();

            // Assert
            mockScanner.Verify(s => s.ScanAsync(), Times.Once);
        }
    }
}
